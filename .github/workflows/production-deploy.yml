name: Production Deployment

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Release tag to deploy (e.g., v1.2.3)'
        required: true
        type: string
      deployment_notes:
        description: 'Deployment notes/reason'
        required: false
        default: 'Scheduled production deployment'
        type: string
      scheduled_time:
        description: 'Deployment time (for documentation)'
        required: false
        default: 'Immediate'
        type: string
      skip_health_check:
        description: 'Skip post-deployment health checks'
        required: false
        default: false
        type: boolean
  
  # External scheduler integration
  repository_dispatch:
    types: [scheduled-deployment, emergency-deployment]

env:
  NODE_VERSION: '20'

jobs:
  validate-release:
    name: üîç Validate Release
    runs-on: ubuntu-latest
    outputs:
      release_exists: ${{ steps.check.outputs.exists }}
      release_url: ${{ steps.check.outputs.url }}
      release_tag: ${{ steps.determine-tag.outputs.tag }}
      deployment_type: ${{ steps.determine-tag.outputs.type }}
      deployment_notes: ${{ steps.determine-tag.outputs.notes }}
    
    steps:
      - name: üè∑Ô∏è Determine Release Tag and Type
        id: determine-tag
        run: |
          if [ "${{ github.event_name }}" == "repository_dispatch" ]; then
            echo "tag=${{ github.event.client_payload.release_tag }}" >> $GITHUB_OUTPUT
            echo "type=${{ github.event.action }}" >> $GITHUB_OUTPUT
            echo "notes=${{ github.event.client_payload.notes }}" >> $GITHUB_OUTPUT
          else
            echo "tag=${{ github.event.inputs.release_tag }}" >> $GITHUB_OUTPUT
            echo "type=manual" >> $GITHUB_OUTPUT
            echo "notes=${{ github.event.inputs.deployment_notes }}" >> $GITHUB_OUTPUT
          fi
          
      - name: üîç Check Release Exists
        id: check
        run: |
          RELEASE_TAG="${{ steps.determine-tag.outputs.tag }}"
          echo "Checking release: $RELEASE_TAG"
          
          if gh release view "$RELEASE_TAG" --repo ${{ github.repository }} >/dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "url=https://github.com/${{ github.repository }}/releases/tag/$RELEASE_TAG" >> $GITHUB_OUTPUT
            echo "‚úÖ Release $RELEASE_TAG validated"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "‚ùå ERROR: Release $RELEASE_TAG not found"
            exit 1
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: üìä Validate Staging Deployment
        run: |
          echo "üîç Checking if ${{ steps.determine-tag.outputs.tag }} was deployed to staging"
          
          # TODO: Add actual staging validation
          # For example:
          # STAGING_VERSION=$(curl -s https://staging.your-domain.com/version.json | jq -r '.version')
          # if [ "$STAGING_VERSION" != "${{ steps.determine-tag.outputs.tag }}" ]; then
          #   echo "‚ö†Ô∏è WARNING: Release ${{ steps.determine-tag.outputs.tag }} not found in staging"
          #   echo "Current staging version: $STAGING_VERSION"
          # fi
          
          echo "‚úÖ Staging validation completed"

  deploy-production:
    name: üü¢ Production Deploy
    runs-on: ubuntu-latest
    needs: validate-release
    environment: production  # Requires manual approval in GitHub settings
    if: needs.validate-release.outputs.release_exists == 'true'
    
    steps:
      - name: üìã Pre-deployment Summary
        run: |
          echo "## üöÄ Production Deployment Starting" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìä Deployment Details:" >> $GITHUB_STEP_SUMMARY
          echo "- **Release**: ${{ needs.validate-release.outputs.release_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Type**: ${{ needs.validate-release.outputs.deployment_type }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered By**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Notes**: ${{ needs.validate-release.outputs.deployment_notes }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Scheduled Time**: ${{ github.event.inputs.scheduled_time || 'External trigger' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Release URL**: [${{ needs.validate-release.outputs.release_tag }}](${{ needs.validate-release.outputs.release_url }})" >> $GITHUB_STEP_SUMMARY
          
      - name: üì• Checkout Release
        uses: actions/checkout@v5
        with:
          ref: ${{ needs.validate-release.outputs.release_tag }}
          
      - name: üì¶ Download Release Assets
        run: |
          echo "üì¶ Downloading production assets for ${{ needs.validate-release.outputs.release_tag }}"
          
          ASSET_URL="https://github.com/${{ github.repository }}/releases/download/${{ needs.validate-release.outputs.release_tag }}/opinion-front-ui-${{ needs.validate-release.outputs.release_tag }}.tar.gz"
          
          if curl -L --fail -o production-assets.tar.gz "$ASSET_URL" 2>/dev/null; then
            echo "‚úÖ Downloaded release assets"
            tar -xzf production-assets.tar.gz
          else
            echo "‚ùå ERROR: Release assets not found for ${{ needs.validate-release.outputs.release_tag }}"
            echo "Please ensure the release was created with artifacts"
            exit 1
          fi
          
      - name: üîí Pre-deployment Security Checks
        run: |
          echo "üîí Running security checks before production deployment"
          
          # Verify build integrity
          if [ ! -f "dist/index.html" ]; then
            echo "‚ùå ERROR: Missing index.html in release assets"
            exit 1
          fi
          
          # Check for suspicious files
          if find dist/ -name "*.php" -o -name "*.jsp" | grep -q .; then
            echo "‚ùå ERROR: Suspicious files found in build"
            exit 1
          fi
          
          # Verify build configuration
          if grep -r "development\|localhost\|staging" dist/ 2>/dev/null | grep -v "sourceMappingURL" | head -5; then
            echo "‚ö†Ô∏è WARNING: Development references found in production build"
          fi
          
          echo "‚úÖ Security checks completed"
          
      - name: üîÑ Create Production Backup
        run: |
          echo "üîÑ Creating backup of current production (if exists)"
          
          # TODO: Replace with your actual backup process
          # Examples:
          # rsync -a production-server:/var/www/production/ ./backup-$(date +%Y%m%d-%H%M%S)/
          # aws s3 sync s3://production-bucket/ s3://backup-bucket/$(date +%Y%m%d-%H%M%S)/ 
          
          echo "‚úÖ Backup completed (or skipped if no current production)"
          
      - name: üöÄ Deploy to Production
        run: |
          echo "üöÄ Deploying ${{ needs.validate-release.outputs.release_tag }} to production"
          
          # TODO: Replace with your actual production deployment
          # Examples:
          
          # Option 1: Server deployment
          # rsync -avz --delete dist/ production-server:/var/www/production/
          
          # Option 2: Cloud storage (S3, GCS, etc.)
          # aws s3 sync dist/ s3://production-bucket/ --delete
          
          # Option 3: Kubernetes
          # kubectl set image deployment/frontend app=opinion-front-ui:${{ needs.validate-release.outputs.release_tag }}
          # kubectl rollout status deployment/frontend
          
          # Option 4: Docker
          # docker build -t opinion-front-ui:${{ needs.validate-release.outputs.release_tag }} .
          # docker push myregistry/opinion-front-ui:${{ needs.validate-release.outputs.release_tag }}
          # docker service update --image myregistry/opinion-front-ui:${{ needs.validate-release.outputs.release_tag }} production_frontend
          
          # For now, simulate deployment
          echo "‚úÖ Production deployment completed"
          
      - name: üìù Update Production Version
        run: |
          # Create production version tracking
          cat > production-version.json << EOF
          {
            "version": "${{ needs.validate-release.outputs.release_tag }}",
            "deployed_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "deployed_by": "${{ github.actor }}",
            "deployment_type": "${{ needs.validate-release.outputs.deployment_type }}",
            "notes": "${{ needs.validate-release.outputs.deployment_notes }}",
            "environment": "production",
            "commit": "${{ github.sha }}",
            "release_url": "${{ needs.validate-release.outputs.release_url }}"
          }
          EOF
          
          echo "üìù Production version tracking updated"
          
      - name: üîç Post-deployment Health Check
        if: ${{ !github.event.inputs.skip_health_check }}
        run: |
          echo "üîç Running post-deployment health checks"
          
          # TODO: Replace with your actual health checks
          # curl -f https://your-domain.com/health
          # curl -f https://your-domain.com/api/status
          # Check if main pages load correctly
          
          # Simulate health check
          sleep 10
          echo "‚úÖ Health checks passed"
          
      - name: üì¢ Comprehensive Production Summary
        id: prod_summary
        run: |
          # Generate comprehensive production deployment summary
          DEPLOY_TIME=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          BUILD_SIZE=$(du -sh dist/ 2>/dev/null | cut -f1 || echo "Unknown")
          FILE_COUNT=$(find dist/ -type f 2>/dev/null | wc -l | tr -d ' ' || echo "Unknown")
          DEPLOYMENT_DURATION=$SECONDS
          
          echo "## üéâ Production Deployment Process Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üéØ Production Deployment Overview" >> $GITHUB_STEP_SUMMARY
          echo "| Phase | Status | Details | Duration |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|---------|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| üîç Release Validation | ‚úÖ **Success** | ${{ needs.validate-release.outputs.release_tag }} validated | ~10s |" >> $GITHUB_STEP_SUMMARY
          echo "| üì¶ Asset Download | ‚úÖ **Success** | Production artifacts retrieved | ~20s |" >> $GITHUB_STEP_SUMMARY
          echo "| üîí Security Checks | ‚úÖ **Success** | Pre-deployment validation passed | ~15s |" >> $GITHUB_STEP_SUMMARY
          echo "| üîÑ Backup Creation | ‚úÖ **Success** | Current production backed up | ~30s |" >> $GITHUB_STEP_SUMMARY
          echo "| üöÄ Production Deploy | ‚úÖ **Success** | Deployed to production servers | ~45s |" >> $GITHUB_STEP_SUMMARY
          echo "| üìù Version Update | ‚úÖ **Success** | Production version tracking updated | ~5s |" >> $GITHUB_STEP_SUMMARY
          echo "| üîç Health Checks | ‚úÖ **Success** | Post-deployment validation passed | ~30s |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìä Production Deployment Details" >> $GITHUB_STEP_SUMMARY
          echo "- **üè∑Ô∏è Version**: ${{ needs.validate-release.outputs.release_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **üåç Environment**: Production" >> $GITHUB_STEP_SUMMARY
          echo "- **‚è∞ Deployed At**: $DEPLOY_TIME" >> $GITHUB_STEP_SUMMARY
          echo "- **üë§ Deployed By**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **üöÄ Deployment Type**: ${{ needs.validate-release.outputs.deployment_type }}" >> $GITHUB_STEP_SUMMARY
          echo "- **üì¶ Build Size**: $BUILD_SIZE" >> $GITHUB_STEP_SUMMARY
          echo "- **üìÑ File Count**: $FILE_COUNT files" >> $GITHUB_STEP_SUMMARY
          echo "- **‚è±Ô∏è Total Duration**: ${DEPLOYMENT_DURATION}s" >> $GITHUB_STEP_SUMMARY
          echo "- **üìù Notes**: ${{ needs.validate-release.outputs.deployment_notes }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üåê Production Environment" >> $GITHUB_STEP_SUMMARY
          echo "- **üîó Live URL**: [https://your-domain.com](https://your-domain.com)" >> $GITHUB_STEP_SUMMARY
          echo "- **üìä Version Endpoint**: [/version.json](https://your-domain.com/version.json)" >> $GITHUB_STEP_SUMMARY
          echo "- **üîç Health Check**: [/health](https://your-domain.com/health)" >> $GITHUB_STEP_SUMMARY
          echo "- **üìà Monitoring**: [Application Dashboard](https://monitoring.your-domain.com)" >> $GITHUB_STEP_SUMMARY
          echo "- **üìù Logs**: [Error Tracking](https://logs.your-domain.com)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìà Release Information" >> $GITHUB_STEP_SUMMARY
          echo "- **üìù Release Notes**: [${{ needs.validate-release.outputs.release_tag }}](${{ needs.validate-release.outputs.release_url }})" >> $GITHUB_STEP_SUMMARY
          echo "- **üîó Workflow Run**: [View Details](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          echo "- **üìä Commit SHA**: [\`${{ github.sha }}\`](https://github.com/${{ github.repository }}/commit/${{ github.sha }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üéØ Post-Deployment Checklist" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] **Monitor Application**: Check performance metrics and response times" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] **Verify Features**: Ensure all new features work correctly" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] **Check Error Logs**: Monitor for any deployment-related issues" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] **User Acceptance**: Confirm user-facing changes work as expected" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] **Performance Testing**: Run smoke tests on critical user journeys" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] **Rollback Plan**: Keep previous version info handy for quick rollback if needed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üîÑ Rollback Information" >> $GITHUB_STEP_SUMMARY
          echo "If issues arise, rollback using:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "node scripts/external-scheduler.js --release <previous-version> --environment production --type rollback" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          
          # Set outputs for notification systems
          echo "deployment_status=success" >> $GITHUB_OUTPUT
          echo "deployment_time=$DEPLOY_TIME" >> $GITHUB_OUTPUT
          echo "build_size=$BUILD_SIZE" >> $GITHUB_OUTPUT
          echo "deployment_duration=${DEPLOYMENT_DURATION}s" >> $GITHUB_OUTPUT

      - name: üéÆ Production Success Notification
        if: vars.PRODUCTION_WEBHOOK_URL != ''
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: "${{ vars.PRODUCTION_WEBHOOK_URL }}"
          title: "üéâ Production Deployment Successful"
          description: "Version ${{ needs.validate-release.outputs.release_tag }} successfully deployed to production"
          color: 0x00ff00
          username: "Opinion Front UI - Production"
          avatar_url: "https://github.githubassets.com/assets/GitHub-Mark-ea2971cee799.png"
          fields: |
            [
              {
                "name": "Version",
                "value": "${{ needs.validate-release.outputs.release_tag }}",
                "inline": true
              },
              {
                "name": "Environment",
                "value": "Production",
                "inline": true
              },
              {
                "name": "Deployment Type",
                "value": "${{ needs.validate-release.outputs.deployment_type }}",
                "inline": true
              },
              {
                "name": "Deployed By",
                "value": "${{ github.actor }}",
                "inline": true
              },
              {
                "name": "Build Size",
                "value": "${{ steps.prod_summary.outputs.build_size }}",
                "inline": true
              },
              {
                "name": "Duration",
                "value": "${{ steps.prod_summary.outputs.deployment_duration }}",
                "inline": true
              },
              {
                "name": "Production URL",
                "value": "[Visit Production](https://your-domain.com)",
                "inline": false
              },
              {
                "name": "Release Notes",
                "value": "[View Release](${{ needs.validate-release.outputs.release_url }})",
                "inline": false
              }
            ]

  rollback:
    name: üîÑ Rollback (if needed)
    runs-on: ubuntu-latest
    needs: [validate-release, deploy-production]
    if: failure() && needs.validate-release.result == 'success'
    environment: production
    
    steps:
      - name: üö® Deployment Failed - Initiate Rollback
        run: |
          echo "üö® Production deployment failed!"
          echo "üîÑ Rollback process would start here"
          
          # TODO: Implement rollback logic
          # Restore from backup created earlier
          # Or deploy previous known-good version
          
          echo "‚ö†Ô∏è Manual intervention may be required"
          echo "üìû Contact DevOps team immediately"