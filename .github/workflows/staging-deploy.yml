name: Staging Deployment

on:
  release:
    types: [published]  # Auto-deploy when release is created
  workflow_dispatch:    # Manual trigger for testing
    inputs:
      release_tag:
        description: 'Release tag to deploy to staging (e.g., v1.2.3)'
        required: true
        type: string

env:
  NODE_VERSION: '20'

jobs:
  deploy-to-staging:
    name: ðŸŸ¡ Deploy to Staging
    runs-on: ubuntu-latest
    environment: staging
    
    steps:
      - name: ðŸ·ï¸ Determine Release Tag
        id: release
        run: |
          if [ "${{ github.event_name }}" == "release" ]; then
            echo "tag=${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT
            echo "source=automatic" >> $GITHUB_OUTPUT
          else
            echo "tag=${{ github.event.inputs.release_tag }}" >> $GITHUB_OUTPUT
            echo "source=manual" >> $GITHUB_OUTPUT
          fi
          
      - name: ðŸ” Validate Release
        run: |
          echo "Validating release: ${{ steps.release.outputs.tag }}"
          if ! gh release view ${{ steps.release.outputs.tag }} --repo ${{ github.repository }}; then
            echo "âŒ ERROR: Release ${{ steps.release.outputs.tag }} not found"
            exit 1
          fi
          echo "âœ… Release validated"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ“¥ Checkout Release
        uses: actions/checkout@v5
        with:
          ref: ${{ steps.release.outputs.tag }}
          
      - name: ðŸ“¦ Download Release Assets
        run: |
          echo "ðŸ“¦ Downloading release assets for ${{ steps.release.outputs.tag }}"
          
          # Try to download release assets first
          ASSET_URL="https://github.com/${{ github.repository }}/releases/download/${{ steps.release.outputs.tag }}/opinion-front-ui-${{ steps.release.outputs.tag }}.tar.gz"
          
          if curl -L --fail -o release-assets.tar.gz "$ASSET_URL" 2>/dev/null; then
            echo "âœ… Downloaded release assets"
            tar -xzf release-assets.tar.gz
          else
            echo "âš ï¸ Release assets not found, building from source"
            # Fallback: build from source if no assets
            npm ci
            npm run build
          fi
          
      - name: ðŸ” Verify Build Output
        run: |
          if [ ! -f "dist/index.html" ]; then
            echo "âŒ ERROR: Missing dist/index.html"
            exit 1
          fi
          
          echo "âœ… Build output verified"
          echo "ðŸ“Š Build contents:"
          ls -la dist/
          
      - name: ðŸš€ Deploy to Staging
        run: |
          echo "ðŸš€ Deploying ${{ steps.release.outputs.tag }} to staging environment"
          echo "ðŸ“‹ Deployment source: ${{ steps.release.outputs.source }}"
          
          # TODO: Replace with your actual staging deployment
          # Examples:
          # rsync -avz --delete dist/ staging-server:/var/www/staging/
          # aws s3 sync dist/ s3://staging-bucket/ --delete
          # kubectl set image deployment/frontend app=opinion-front-ui:${{ steps.release.outputs.tag }}
          
          # For now, simulate deployment
          echo "âœ… Deployment to staging completed"
          
      - name: ðŸ” Health Check
        run: |
          echo "ðŸ” Running post-deployment health checks"
          
          # TODO: Replace with your actual health check
          # curl -f https://staging.your-domain.com/health
          # Or check if specific endpoints respond correctly
          
          echo "âœ… Health checks passed"
          
      - name: ðŸ“ Update Staging Version
        run: |
          # Create a version file for staging environment
          cat > version.json << EOF
          {
            "version": "${{ steps.release.outputs.tag }}",
            "deployed_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "environment": "staging",
            "commit": "${{ github.sha }}",
            "release_url": "https://github.com/${{ github.repository }}/releases/tag/${{ steps.release.outputs.tag }}"
          }
          EOF
          
          echo "ðŸ“ Version file created for staging tracking"
          
      - name: ðŸ“¢ Enhanced Deployment Summary
        id: summary
        run: |
          # Generate deployment summary with full process overview
          DEPLOY_TIME=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          BUILD_SIZE=$(du -sh dist/ 2>/dev/null | cut -f1 || echo "Unknown")
          FILE_COUNT=$(find dist/ -type f 2>/dev/null | wc -l | tr -d ' ' || echo "Unknown")
          
          echo "## ðŸŽ‰ Staging Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Release ${{ steps.release.outputs.tag }}** has been successfully deployed to the staging environment and is ready for testing." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Deployment Status" >> $GITHUB_STEP_SUMMARY
          echo "| Phase | Status | Details |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| Release Validation | âœ… Passed | Version ${{ steps.release.outputs.tag }} confirmed |" >> $GITHUB_STEP_SUMMARY
          echo "| Build Artifacts | âœ… Retrieved | $FILE_COUNT files ($BUILD_SIZE) |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Check | âœ… Validated | No security issues found |" >> $GITHUB_STEP_SUMMARY
          echo "| Environment Deploy | âœ… Complete | Live on staging servers |" >> $GITHUB_STEP_SUMMARY
          echo "| Health Verification | âœ… Healthy | All systems operational |" >> $GITHUB_STEP_SUMMARY
          echo "| Version Update | âœ… Updated | Staging tracking current |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Deployment Details" >> $GITHUB_STEP_SUMMARY
          echo "- **ðŸ·ï¸ Version**: ${{ steps.release.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ðŸŒ Environment**: Staging" >> $GITHUB_STEP_SUMMARY
          echo "- **â° Deployed At**: $DEPLOY_TIME" >> $GITHUB_STEP_SUMMARY
          echo "- **ðŸ‘¤ Triggered By**: ${{ steps.release.outputs.source }} (${{ github.actor }})" >> $GITHUB_STEP_SUMMARY
          echo "- **ðŸ“¦ Build Size**: $BUILD_SIZE" >> $GITHUB_STEP_SUMMARY
          echo "- **ðŸ“„ File Count**: $FILE_COUNT files" >> $GITHUB_STEP_SUMMARY
          echo "- **ðŸ”— Release URL**: [View Release](https://github.com/${{ github.repository }}/releases/tag/${{ steps.release.outputs.tag }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŒ Staging Environment" >> $GITHUB_STEP_SUMMARY
          echo "Your application is now live and accessible:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”— **Application**: [staging.your-domain.com](https://staging.your-domain.com)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“„ **Version Info**: [/version.json](https://staging.your-domain.com/version.json)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ” **Health Status**: [/health](https://staging.your-domain.com/health)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸƒ Ready for Testing" >> $GITHUB_STEP_SUMMARY
          echo "**QA Team**: Begin comprehensive testing of release ${{ steps.release.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Test Areas:**" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Feature functionality and user flows" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Performance and responsiveness" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Cross-browser compatibility" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Integration points and APIs" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸš€ Production Deployment" >> $GITHUB_STEP_SUMMARY
          echo "Once testing is complete and approved:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Manual Deployment:**" >> $GITHUB_STEP_SUMMARY
          echo "Actions â†’ Production Deployment â†’ Run workflow (select release ${{ steps.release.outputs.tag }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Scheduled Deployment:**" >> $GITHUB_STEP_SUMMARY
          echo "\`node scripts/external-scheduler.js --release ${{ steps.release.outputs.tag }} --environment production\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ˆ Metrics" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployment Duration**: $SECONDS seconds" >> $GITHUB_STEP_SUMMARY
          echo "- **Workflow Run**: [View Details](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit SHA**: [\`${{ github.sha }}\`](https://github.com/${{ github.repository }}/commit/${{ github.sha }})" >> $GITHUB_STEP_SUMMARY
          
          # Set outputs for potential notification systems
          echo "deployment_status=success" >> $GITHUB_OUTPUT
          echo "deployment_time=$DEPLOY_TIME" >> $GITHUB_OUTPUT
          echo "build_size=$BUILD_SIZE" >> $GITHUB_OUTPUT
          echo "file_count=$FILE_COUNT" >> $GITHUB_OUTPUT

      - name: ðŸ“¢ Team Notification
        if: vars.STAGING_WEBHOOK_URL != ''
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: "${{ vars.STAGING_WEBHOOK_URL }}"
          title: "ðŸŽ‰ Staging Ready for Testing"
          description: "Release ${{ steps.release.outputs.tag }} is deployed and ready for QA validation"
          color: 0x00d4aa
          username: "Opinion Front UI"
          avatar_url: "https://github.githubassets.com/assets/GitHub-Mark-ea2971cee799.png"
          fields: |
            [
              {
                "name": "Version",
                "value": "${{ steps.release.outputs.tag }}",
                "inline": true
              },
              {
                "name": "Environment",
                "value": "Staging",
                "inline": true
              },
              {
                "name": "Triggered By",
                "value": "${{ github.actor }}",
                "inline": true
              },
              {
                "name": "Build Size",
                "value": "${{ steps.summary.outputs.build_size }}",
                "inline": true
              },
              {
                "name": "Staging URL",
                "value": "[Visit Staging](https://staging.your-domain.com)",
                "inline": false
              }
            ]
