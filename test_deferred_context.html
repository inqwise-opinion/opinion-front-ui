<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deferred withContext Test</title>
    <link rel="stylesheet" href="src/assets/css/main.css">
    <style>
        .test-container {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .code-example {
            background: #f8f8f2;
            color: #272822;
            padding: 1rem;
            border-radius: 0.25rem;
            margin: 1rem 0;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.875rem;
            line-height: 1.4;
            white-space: pre-wrap;
        }
        
        .log {
            background: #000;
            color: #0f0;
            padding: 1rem;
            border-radius: 0.25rem;
            font-family: monospace;
            max-height: 400px;
            overflow-y: auto;
            font-size: 0.875rem;
            line-height: 1.4;
        }
        
        .log .info { color: #00ffff; }
        .log .success { color: #00ff00; }
        .log .warning { color: #ffff00; }
        .log .error { color: #ff0000; }
        
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.25rem;
            margin: 0.25rem;
            cursor: pointer;
        }
        
        button:hover {
            background: #0056b3;
        }
    </style>
</head>
<body>
    <!-- Required layout structure -->
    <div class="app-layout">
        <div id="app-error-messages" class="app-error-messages" role="alert" aria-live="polite" style="display: none;"></div>
        <div class="app-header">
            <h1>‚è±Ô∏è Deferred withContext Test</h1>
        </div>
        <div class="app-content-scroll">
            <main class="app-main" id="app">
                <div class="test-container">
                    <h2>üéØ Testing Deferred withContext() Execution</h2>
                    <p>The updated <code>withContext()</code> method saves handlers and executes them when LayoutContext is fully initialized:</p>
                    
                    <div class="code-example">
<strong>New Behavior:</strong>
// Handlers called BEFORE layout.init() will be deferred
layout
  .withContext(ctx => console.log('This will wait'))
  .init()  // Handlers execute after this completes

// Handlers called AFTER layout.init() execute immediately
layout
  .withContext(ctx => console.log('This executes immediately'))
                    </div>
                    
                    <div>
                        <h3>üß™ Test Deferred Execution</h3>
                        <button onclick="testBeforeInit()">Test Before Init (Deferred)</button>
                        <button onclick="testAfterInit()">Test After Init (Immediate)</button>
                        <button onclick="testFullWorkflow()">Test Full Workflow</button>
                        <button onclick="testMultipleDeferred()">Test Multiple Deferred</button>
                        <button onclick="clearLog()">Clear Log</button>
                    </div>
                </div>

                <div class="test-container">
                    <h3>üìã Test Results</h3>
                    <div id="test-log" class="log"></div>
                </div>
            </main>
        </div>
    </div>

    <script type="module">
        import Layout from './src/components/Layout.js';

        let layout = null;

        function log(message, type = 'info') {
            const logDiv = document.getElementById('test-log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type;
            logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // Test functions
        window.testBeforeInit = () => {
            log('üîç Testing withContext BEFORE init (should defer)...', 'info');
            
            try {
                // Create new layout (not initialized)
                layout = new Layout({
                    header: { enabled: true, brandTitle: 'Deferred Test' },
                    sidebar: { enabled: false },
                    footer: { enabled: true }
                });
                
                log('‚úÖ Layout created (not initialized yet)', 'success');
                
                // Call withContext before init - should defer
                layout.withContext(ctx => {
                    log('üéâ DEFERRED HANDLER EXECUTED!', 'success');
                    log(`LayoutContext ready: ${ctx.isReady()}`, 'info');
                    
                    const messages = ctx.getMessages();
                    if (messages) {
                        log('‚úÖ Messages available in deferred handler', 'success');
                    } else {
                        log('‚ùå Messages NOT available in deferred handler', 'error');
                    }
                });
                
                log('‚úÖ withContext() called before init - handler should be deferred', 'warning');
                
                // Now initialize - should trigger deferred handler
                setTimeout(async () => {
                    log('üöÄ Now initializing layout...', 'info');
                    await layout.init();
                    log('‚úÖ Layout initialization complete - deferred handler should have executed', 'success');
                }, 1000);
                
            } catch (error) {
                log(`‚ùå Test failed: ${error.message}`, 'error');
            }
        };

        window.testAfterInit = async () => {
            log('üîç Testing withContext AFTER init (should execute immediately)...', 'info');
            
            try {
                // Ensure we have an initialized layout
                if (!layout || !layout.isLayoutInitialized) {
                    layout = new Layout({
                        header: { enabled: true, brandTitle: 'Immediate Test' },
                        sidebar: { enabled: false },
                        footer: { enabled: true }
                    });
                    await layout.init();
                    log('‚úÖ Fresh layout initialized', 'success');
                }
                
                // Call withContext after init - should execute immediately
                layout.withContext(ctx => {
                    log('‚ö° IMMEDIATE HANDLER EXECUTED!', 'success');
                    log(`LayoutContext ready: ${ctx.isReady()}`, 'info');
                    
                    const viewport = ctx.getViewport();
                    log(`Viewport: ${viewport.width}x${viewport.height}`, 'info');
                });
                
                log('‚úÖ withContext() called after init - handler executed immediately', 'success');
                
            } catch (error) {
                log(`‚ùå Test failed: ${error.message}`, 'error');
            }
        };

        window.testFullWorkflow = async () => {
            log('üîç Testing full workflow with mixed timing...', 'info');
            
            try {
                // Create new layout
                layout = new Layout({
                    header: { enabled: true, brandTitle: 'Workflow Test' },
                    sidebar: { enabled: false },
                    footer: { enabled: true }
                });
                
                log('‚úÖ Layout created', 'success');
                
                // Add handlers before init
                layout
                    .withContext(ctx => log('üìã Handler 1: Deferred execution', 'warning'))
                    .withContext(ctx => log('üìã Handler 2: Also deferred', 'warning'));
                
                log('‚úÖ Two handlers added before init', 'info');
                
                // Initialize
                await layout.init();
                log('‚úÖ Layout initialized - deferred handlers should have executed', 'success');
                
                // Add handlers after init
                layout
                    .withContext(ctx => log('‚ö° Handler 3: Immediate execution', 'info'))
                    .withContext(ctx => log('‚ö° Handler 4: Also immediate', 'info'));
                
                log('‚úÖ Full workflow test complete', 'success');
                
            } catch (error) {
                log(`‚ùå Workflow test failed: ${error.message}`, 'error');
            }
        };

        window.testMultipleDeferred = () => {
            log('üîç Testing multiple deferred handlers...', 'info');
            
            try {
                // Create fresh layout
                layout = new Layout({
                    header: { enabled: true, brandTitle: 'Multiple Deferred Test' },
                    sidebar: { enabled: false },
                    footer: { enabled: true }
                });
                
                // Add multiple deferred handlers
                for (let i = 1; i <= 5; i++) {
                    layout.withContext(ctx => {
                        log(`üìã Deferred handler ${i} executed`, 'warning');
                    });
                }
                
                log('‚úÖ 5 deferred handlers added', 'info');
                
                // Initialize after delay
                setTimeout(async () => {
                    log('üöÄ Initializing layout...', 'info');
                    await layout.init();
                    log('‚úÖ All deferred handlers should have executed', 'success');
                }, 2000);
                
            } catch (error) {
                log(`‚ùå Multiple deferred test failed: ${error.message}`, 'error');
            }
        };

        window.clearLog = () => {
            document.getElementById('test-log').innerHTML = '';
        };

        // Initialize on load
        log('üöÄ Deferred withContext test page loaded', 'info');
        log('‚úÖ Ready to test deferred execution patterns', 'success');
    </script>
</body>
</html>
