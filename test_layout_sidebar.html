<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Layout Sidebar Management Test</title>
    <link rel="stylesheet" href="src/assets/css/main.css">
    <style>
        body { font-family: Arial, sans-serif; }
        .controls { 
            position: fixed; 
            top: 20px; 
            right: 20px; 
            background: white; 
            padding: 15px; 
            border: 1px solid #ccc; 
            border-radius: 5px; 
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            width: 300px;
        }
        .controls h3 { margin-top: 0; }
        .controls button { 
            display: block; 
            width: 280px; 
            padding: 8px; 
            margin: 5px 0; 
            cursor: pointer;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 3px;
        }
        .controls button:hover { background: #0056b3; }
        .status { 
            background: #e1f5fe; 
            padding: 15px; 
            border-radius: 5px; 
            margin: 20px; 
            font-weight: bold;
        }
        .log { 
            background: #f0f0f0; 
            padding: 10px; 
            border-radius: 5px; 
            margin: 20px; 
            font-family: monospace; 
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        .config-display {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 20px;
            border: 1px solid #dee2e6;
        }
        .config-display h3 { margin-top: 0; }
        .info { color: #007bff; }
        .success { color: #28a745; }
        .warning { color: #ffc107; }
        .error { color: #dc3545; }
    </style>
</head>
<body>
    <!-- Required layout structure -->
    <div class="app-layout">
        <div id="app-error-messages" class="app-error-messages" role="alert" aria-live="polite" style="display: none;"></div>
        <div id="app-sidebar" class="app-sidebar">
            <div class="sidebar-header"></div>
            <div class="sidebar-navigation"></div>
            <div class="sidebar-footer"></div>
        </div>
        <div class="app-content-scroll">
            <div id="app-header" class="app-header">
                <div class="header-container"></div>
            </div>
            <main class="app-main" id="app">
                <div class="status" id="status">
                    Layout Sidebar Management Test: <span id="layout-status">Loading...</span>
                </div>

                <div class="config-display">
                    <h3>üèóÔ∏è Architecture Changes</h3>
                    <p><strong>Change 1:</strong> Sidebar management moved from AppHeaderImpl to Layout class</p>
                    <p><strong>Change 2:</strong> registerComponentsWithContext() now called before each init()</p>
                    <br>
                    <h4>Benefits:</h4>
                    <ul>
                        <li>‚úÖ Clean separation of concerns</li>
                        <li>‚úÖ Layout class manages all layout components</li>
                        <li>‚úÖ Header focuses only on header functionality</li>
                        <li>‚úÖ Centralized sidebar configuration</li>
                        <li>‚úÖ Mobile toggle works through LayoutContext</li>
                        <li>‚úÖ Component registration happens accurately before each init()</li>
                        <li>‚úÖ Safe to call init() multiple times</li>
                        <li>‚úÖ Proper component lifecycle management</li>
                    </ul>
                </div>
                
                <h2>üèóÔ∏è Testing Layout Component Management</h2>
                <p>This test demonstrates two key architecture improvements:</p>
                <ol>
                    <li><strong>Sidebar Management:</strong> Moved from AppHeaderImpl to Layout class</li>
                    <li><strong>Component Registration:</strong> registerComponentsWithContext() now called before each init()</li>
                </ol>

                <div id="test-log" class="log"></div>
            </main>
            <footer class="app-footer">
                <p>Footer - Layout Sidebar Test</p>
            </footer>
        </div>
    </div>

    <div class="controls">
        <h3>üéõÔ∏è Layout Sidebar Controls</h3>
        
        <button onclick="initializeLayout()">Initialize Layout with Sidebar</button>
        <button onclick="testSidebarAccess()">Test Sidebar Access</button>
        <button onclick="testMobileToggle()">Test Mobile Toggle</button>
        <button onclick="testSidebarMethods()">Test Sidebar Methods</button>
        <button onclick="testLayoutContext()">Test LayoutContext Access</button>
        <button onclick="testConfiguration()">Test Sidebar Configuration</button>
        <button onclick="testMultipleInits()">Test Multiple Init Calls</button>
        <button onclick="destroyAndRecreate()">Destroy and Recreate</button>
        <button onclick="clearLog()">Clear Log</button>
    </div>

    <script type="module">
        import Layout from './src/components/Layout.js';

        let layout = null;

        function log(message, type = 'info') {
            const logDiv = document.getElementById('test-log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type;
            logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }

        function updateStatus(status) {
            document.getElementById('layout-status').textContent = status;
        }

        window.initializeLayout = async () => {
            log('üöÄ Initializing Layout with sidebar configuration...', 'info');
            updateStatus('Initializing...');
            
            try {
                // Clean up existing layout
                if (layout) {
                    log('üóëÔ∏è Destroying existing layout...', 'info');
                    layout.destroy();
                    log('‚úÖ Existing layout destroyed', 'success');
                }

                // Create layout with sidebar configuration
                log('üèóÔ∏è Creating new Layout instance...', 'info');
                layout = new Layout({
                    header: { 
                        enabled: true,
                        brandTitle: 'Sidebar Test',
                        showMobileToggle: true 
                    },
                    sidebar: { 
                        enabled: true,
                        defaultWidth: 280,
                        compactWidth: 80,
                        footer: {
                            text: '¬© 2025 Layout Managed',
                            showFooter: true
                        }
                    },
                    footer: { enabled: true }
                });
                log('‚úÖ Layout instance created', 'success');

                log('üîÑ Calling layout.init() - registerComponentsWithContext should be called BEFORE initialization...', 'info');
                await layout.init();
                log('‚úÖ Layout initialized with sidebar managed by Layout class', 'success');
                log('üéØ Key Fix: registerComponentsWithContext() is now called at START of init()', 'info');
                updateStatus('Active - Sidebar managed by Layout');
                
            } catch (error) {
                log(`‚ùå Layout initialization failed: ${error.message}`, 'error');
                updateStatus('Error');
            }
        };

        window.testSidebarAccess = () => {
            log('üîç Testing sidebar access methods...', 'info');
            
            if (!layout) {
                log('‚ùå No layout available for testing', 'error');
                return;
            }

            try {
                // Test direct access from Layout
                const sidebarFromLayout = layout.getSidebar();
                log(`‚úÖ Layout.getSidebar(): ${sidebarFromLayout ? 'Available' : 'Not Available'}`, sidebarFromLayout ? 'success' : 'error');

                // Test access from LayoutContext
                const layoutContext = layout.getLayoutContext();
                const sidebarFromContext = layoutContext.getSidebar();
                log(`‚úÖ LayoutContext.getSidebar(): ${sidebarFromContext ? 'Available' : 'Not Available'}`, sidebarFromContext ? 'success' : 'error');

                // Test that they're the same instance
                if (sidebarFromLayout && sidebarFromContext) {
                    const isSameInstance = sidebarFromLayout === sidebarFromContext;
                    log(`‚úÖ Same sidebar instance: ${isSameInstance}`, isSameInstance ? 'success' : 'warning');
                }

                // Test header no longer has sidebar
                const header = layout.getHeader();
                log(`‚úÖ Header no longer manages sidebar directly`, 'success');
                
            } catch (error) {
                log(`‚ùå Sidebar access test failed: ${error.message}`, 'error');
            }
        };

        window.testMobileToggle = () => {
            log('üì± Testing mobile toggle functionality...', 'info');
            
            if (!layout) {
                log('‚ùå No layout available for testing', 'error');
                return;
            }

            try {
                // Simulate mobile toggle click
                const mobileToggle = document.getElementById('mobile_menu_toggle');
                if (mobileToggle) {
                    log('üîÑ Simulating mobile menu toggle click...', 'info');
                    mobileToggle.click();
                    log('‚úÖ Mobile toggle clicked - should work via LayoutContext', 'success');
                } else {
                    log('‚ö†Ô∏è Mobile toggle button not found (may be disabled in config)', 'warning');
                }
                
            } catch (error) {
                log(`‚ùå Mobile toggle test failed: ${error.message}`, 'error');
            }
        };

        window.testSidebarMethods = () => {
            log('üß™ Testing sidebar method calls...', 'info');
            
            if (!layout) {
                log('‚ùå No layout available for testing', 'error');
                return;
            }

            try {
                const sidebar = layout.getSidebar();
                if (sidebar) {
                    // Test compact mode
                    const isCompact = sidebar.isCompactMode();
                    log(`üìè Sidebar compact mode: ${isCompact}`, 'info');

                    // Test dimensions
                    const dimensions = sidebar.getDimensions();
                    log(`üìê Sidebar dimensions: ${dimensions.width}px, visible: ${dimensions.isVisible}`, 'info');

                    // Test configuration
                    const config = sidebar.getConfig();
                    log(`‚öôÔ∏è Sidebar config: default=${config.defaultWidth}px, compact=${config.compactWidth}px`, 'info');
                    log(`‚öôÔ∏è Footer config: "${config.footer.text}", show: ${config.footer.showFooter}`, 'info');
                    
                    log('‚úÖ All sidebar methods accessible via Layout', 'success');
                } else {
                    log('‚ùå Sidebar not available from Layout', 'error');
                }
                
            } catch (error) {
                log(`‚ùå Sidebar methods test failed: ${error.message}`, 'error');
            }
        };

        window.testLayoutContext = () => {
            log('üåê Testing LayoutContext integration...', 'info');
            
            if (!layout) {
                log('‚ùå No layout available for testing', 'error');
                return;
            }

            try {
                const layoutContext = layout.getLayoutContext();
                
                // Test sidebar registration
                const hasSidebar = layoutContext.hasSidebar();
                log(`‚úÖ LayoutContext.hasSidebar(): ${hasSidebar}`, hasSidebar ? 'success' : 'error');

                // Test withSidebar callback
                layoutContext.withSidebar(sidebar => {
                    log('‚úÖ LayoutContext.withSidebar() callback executed', 'success');
                    log(`   Sidebar type: ${sidebar.constructor.name}`, 'info');
                    log(`   Compact mode: ${sidebar.isCompactMode()}`, 'info');
                });

                log('‚úÖ LayoutContext integration working correctly', 'success');
                
            } catch (error) {
                log(`‚ùå LayoutContext test failed: ${error.message}`, 'error');
            }
        };

        window.testConfiguration = () => {
            log('‚öôÔ∏è Testing sidebar configuration retrieval...', 'info');
            
            if (!layout) {
                log('‚ùå No layout available for testing', 'error');
                return;
            }

            try {
                // Test Layout configuration methods
                const sidebarConfig = layout.getSidebarConfig();
                log(`‚úÖ Layout.getSidebarConfig():`, 'success');
                log(`   defaultWidth: ${sidebarConfig.defaultWidth}px`, 'info');
                log(`   compactWidth: ${sidebarConfig.compactWidth}px`, 'info');
                log(`   footer.text: "${sidebarConfig.footer.text}"`, 'info');
                log(`   footer.showFooter: ${sidebarConfig.footer.showFooter}`, 'info');

                const footerConfig = layout.getSidebarFooterConfig();
                log(`‚úÖ Layout.getSidebarFooterConfig():`, 'success');
                log(`   text: "${footerConfig.text}"`, 'info');
                log(`   showFooter: ${footerConfig.showFooter}`, 'info');

                log('‚úÖ Configuration retrieval working correctly', 'success');
                
            } catch (error) {
                log(`‚ùå Configuration test failed: ${error.message}`, 'error');
            }
        };

        window.testMultipleInits = async () => {
            log('üîÑ Testing multiple init() calls on same Layout instance...', 'info');
            updateStatus('Testing Multiple Inits...');
            
            if (!layout) {
                log('‚ùå No layout available for testing', 'error');
                return;
            }

            try {
                log('üéØ Test: Calling init() multiple times should work correctly', 'info');
                log('üîÑ First additional init() call...', 'info');
                await layout.init();
                log('‚úÖ First additional init() completed - registerComponentsWithContext should have been called', 'success');
                
                log('üîÑ Second additional init() call...', 'info');
                await layout.init();
                log('‚úÖ Second additional init() completed - registerComponentsWithContext should have been called', 'success');
                
                // Verify components are still accessible
                const sidebar = layout.getSidebar();
                const header = layout.getHeader();
                const layoutContext = layout.getLayoutContext();
                
                log(`‚úÖ After multiple inits: Sidebar=${sidebar ? 'Available' : 'Missing'}, Header=${header ? 'Available' : 'Missing'}, Context=${layoutContext ? 'Available' : 'Missing'}`, 'success');
                log('‚úÖ Multiple init() test completed successfully', 'success');
                
            } catch (error) {
                log(`‚ùå Multiple inits test failed: ${error.message}`, 'error');
                updateStatus('Error');
            }
        };

        window.destroyAndRecreate = async () => {
            log('üîÑ Testing destroy and recreate cycle...', 'info');
            updateStatus('Testing Lifecycle...');
            
            try {
                if (layout) {
                    log('üóëÔ∏è Destroying current layout...', 'info');
                    layout.destroy();
                    layout = null;
                    log('‚úÖ Layout destroyed', 'success');
                    
                    // Wait a moment
                    setTimeout(async () => {
                        log('üîÑ Creating new layout...', 'info');
                        await window.initializeLayout();
                        log('‚úÖ Layout lifecycle test completed', 'success');
                    }, 1000);
                } else {
                    log('‚ö†Ô∏è No layout to destroy, creating new one...', 'warning');
                    await window.initializeLayout();
                }
                
            } catch (error) {
                log(`‚ùå Lifecycle test failed: ${error.message}`, 'error');
                updateStatus('Error');
            }
        };

        window.clearLog = () => {
            document.getElementById('test-log').innerHTML = '';
        };

        // Initialize automatically
        log('üéØ Layout Component Management test starting...', 'info');
        log('üìã Architecture Change 1: Sidebar now managed by Layout class instead of AppHeaderImpl', 'info');
        log('üìã Architecture Change 2: registerComponentsWithContext() now called before each init()', 'info');
        window.initializeLayout();
    </script>
</body>
</html>
